

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Integration with TeamCity &mdash; Universum 0.12.4 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="_static/theme_overrides.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="Universum 0.12.4 documentation" href="index.html"/>
        <link rel="next" title="Change log" href="changelog_ref.html"/>
        <link rel="prev" title="&#39;configuration_support&#39; module" href="configuration_support.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> Universum
          

          
          </a>

          
            
            
              <div class="version">
                0.12.4
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="prerequisites.html">Prerequisites</a></li>
<li class="toctree-l1"><a class="reference internal" href="args.html">Command line</a></li>
<li class="toctree-l1"><a class="reference internal" href="configuring.html">Configuring the project</a></li>
<li class="toctree-l1"><a class="reference internal" href="configuration_support.html">'configuration_support' module</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Integration with TeamCity</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#install-universum-on-build-agents">Install Universum on build agents</a></li>
<li class="toctree-l2"><a class="reference internal" href="#create-a-top-level-project">Create a top-level project</a></li>
<li class="toctree-l2"><a class="reference internal" href="#create-a-common-meta-runner">Create a common meta-runner</a></li>
<li class="toctree-l2"><a class="reference internal" href="#configure-project-using-perforce">Configure project using Perforce</a></li>
<li class="toctree-l2"><a class="reference internal" href="#create-basic-postcommit-configuration">Create basic postcommit configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="#create-configuration-for-custom-builds">Create configuration for custom builds</a></li>
<li class="toctree-l2"><a class="reference internal" href="#integrate-with-swarm">Integrate with Swarm</a></li>
<li class="toctree-l2"><a class="reference internal" href="#configure-project-and-configurations-using-git">Configure project and configurations using Git</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="changelog_ref.html">Change log</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Universum</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Integration with TeamCity</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/teamcity.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="integration-with-teamcity">
<h1>Integration with TeamCity<a class="headerlink" href="#integration-with-teamcity" title="Permalink to this headline">¶</a></h1>
<p>The main design goal of Universum is to <a class="reference internal" href="index.html"><span class="doc">integrate with various CI systems</span></a>.
E.g. continuous integration/automation, version control, static analysis, testing, etc.</p>
<p>One of popular continuous integration systems is TeamCity, and this particular tutorial will explain
how to integrate it with Universum.</p>
<p>The proposed scenario includes the following steps:</p>
<ol class="arabic" start="0">
<li><p class="first">Install and configure both TeamCity and Universum systems, prepare TeamCity build servers for
project building/running/testing/etc.</p>
</li>
<li><p class="first">Create a project on TeamCity. Configure common parameters for the project:</p>
<blockquote>
<div><ol class="loweralpha simple">
<li>project parameters, if any</li>
<li>parameters for Universum</li>
</ol>
</div></blockquote>
<p>TeamCity configurations automatically inherit all project settings,
so configuring them once on project-level allows to avoid multiple reconfiguring
of same parameters in each configuration, and all changes applied to project settings
are automatically applied to all inherited settings</p>
</li>
<li><p class="first">Create a common
<a class="reference external" href="https://confluence.jetbrains.com/display/TCD8/Working+with+Meta-Runner">TeamCity meta-runner</a>.
TeamCity offers two ways of using meta-runners:</p>
<blockquote>
<div><ol class="loweralpha simple">
<li>creating a new configuration out of existing meta-runner</li>
<li>using an existing meta-runner as a build step</li>
</ol>
</div></blockquote>
<p>Both of this scenarios have their own benefits: when creating a configuration, all parameters
are inherited too; but when using a build step, any change in meta-runner automatically
affects all configurations using it</p>
</li>
<li><p class="first">Create all needed configurations, such as:</p>
<blockquote>
<div><ul class="simple">
<li>precommit check</li>
<li>postcommit check</li>
<li>testing</li>
<li>etc.</li>
</ul>
</div></blockquote>
</li>
</ol>
<p>This scenario pays a lot of attention to reusing settings instead of just copying them.
It is most important in cases when some of these settings have to be changed: if generalized
on project level, there's only one place to fix. And if all similar settings are duplicated,
tracking changes becomes more difficult the more times they are copied.</p>
<div class="section" id="install-universum-on-build-agents">
<h2>Install Universum on build agents<a class="headerlink" href="#install-universum-on-build-agents" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple" start="0">
<li>Download Universum sources to the build server</li>
<li>Install Universum on build server by running <code class="docutils literal"><span class="pre">sudo</span> <span class="pre">pip</span> <span class="pre">install</span> <span class="pre">.</span></code> in Universum sources root directory</li>
<li>Install and configure TeamCity server</li>
<li>Install build agents on build server, add them to the project pool</li>
</ol>
<p>Please refer to
<a class="reference external" href="https://www.jetbrains.com/teamcity/documentation/">TeamCity official manuals</a> for details.</p>
</div>
<div class="section" id="create-a-top-level-project">
<h2>Create a top-level project<a class="headerlink" href="#create-a-top-level-project" title="Permalink to this headline">¶</a></h2>
<ol class="arabic" start="0">
<li><p class="first">Create new project for all Universum configurations or add a sub-project to an existing one</p>
</li>
<li><p class="first">Go to <cite>Parameters</cite> section in Project Settings and add the following parameters:</p>
<blockquote>
<div><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">env.BUILD_ID:</th><td class="field-body"><code class="docutils literal"><span class="pre">%teamcity.build.id%</span></code></td>
</tr>
<tr class="field-even field"><th class="field-name">env.CONFIGURATION_ID:</th><td class="field-body"><code class="docutils literal"><span class="pre">%system.teamcity.buildType.id%</span></code></td>
</tr>
<tr class="field-odd field"><th class="field-name">env.TEAMCITY_SERVER:</th><td class="field-body">server URL to refer to in reports</td>
</tr>
<tr class="field-even field"><th class="field-name">env.CONFIGURATION_PARAMETERS:</th><td class="field-body">will be used in meta-runner; leave empty so far</td>
</tr>
</tbody>
</table>
</div></blockquote>
</li>
</ol>
<p>Making all projects using Universum sub-projects to this one will automatically add all these
parameters to their settings.</p>
</div>
<div class="section" id="create-a-common-meta-runner">
<h2>Create a common meta-runner<a class="headerlink" href="#create-a-common-meta-runner" title="Permalink to this headline">¶</a></h2>
<ol class="arabic" start="0">
<li><p class="first">Create an .xml file with the following content:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;meta-runner name=&quot;Run build using CI system&quot;&gt;
  &lt;description&gt;Basic project configuration&lt;/description&gt;
  &lt;settings&gt;
    &lt;build-runners&gt;
      &lt;runner name=&quot;Global script&quot; type=&quot;simpleRunner&quot;&gt;
        &lt;parameters&gt;
          &lt;param name=&quot;script.content&quot;&gt;&lt;![CDATA[
#!/bin/bash

EXITCODE=0

HOST=`hostame | sed -e &quot;s/_/-/&quot;`
USER=`whoami | sed -e &quot;s/_/-/&quot;`
P4CLIENT=&quot;Disposable_workspace_&quot;$HOST&quot;-&quot;$USER

cmd=&quot;universum --p4-client ${P4CLIENT} --p4-force-clean %env.CONFIGURATION_PARAMETERS%&quot;
echo &quot;==&gt; Run: ${cmd}&quot;
${cmd} || EXITCODE=1

exit $EXITCODE
          ]]&gt;&lt;/param&gt;
          &lt;param name=&quot;teamcity.step.mode&quot; value=&quot;default&quot; /&gt;
          &lt;param name=&quot;use.custom.script&quot; value=&quot;true&quot; /&gt;
        &lt;/parameters&gt;
      &lt;/runner&gt;
    &lt;/build-runners&gt;
  &lt;/settings&gt;
&lt;/meta-runner&gt;
</pre></div>
</div>
</li>
</ol>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Universum default VCS type is Perforce, so this meta-runner is oriented to be used with P4.
But the same meta-runner can be used for configurations using any other VCS type.
Unused P4 parameters will be just ignored.</p>
</div>
<ol class="arabic simple">
<li>In <cite>Project Settings</cite> find <cite>Meta-Runners</cite> page and press <code class="docutils literal"><span class="pre">Upload</span> <span class="pre">Meta-Runner</span></code></li>
<li>Select your newly created .xml file as a <cite>Meta-Runner file</cite></li>
</ol>
</div>
<div class="section" id="configure-project-using-perforce">
<h2>Configure project using Perforce<a class="headerlink" href="#configure-project-using-perforce" title="Permalink to this headline">¶</a></h2>
<ol class="arabic" start="0">
<li><p class="first">Create a sub-project to a created earlier top-level project</p>
</li>
<li><p class="first">Go to <cite>Parameters</cite> in <cite>Project Settings</cite></p>
</li>
<li><p class="first">Add <code class="docutils literal"><span class="pre">env.CONFIG_PATH</span></code>: a relative path to project <a class="reference internal" href="configuring.html"><span class="doc">configuration file</span></a>,
starting from project root</p>
</li>
<li><p class="first">Also add all required project-wide Perforce parameters:</p>
<blockquote>
<div><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">env.P4USER:</th><td class="field-body">Perforce user ID</td>
</tr>
<tr class="field-even field"><th class="field-name">env.P4PASSWD:</th><td class="field-body">user &lt;env.P4USER&gt; password</td>
</tr>
<tr class="field-odd field"><th class="field-name">env.P4PORT:</th><td class="field-body">Perforce server URL (including port if needed)</td>
</tr>
<tr class="field-even field"><th class="field-name">env.P4_MAPPINGS:</th><td class="field-body">Perforce mappings in <a class="reference internal" href="args.html"><span class="doc">special format</span></a>.
Also can be replaced with legacy <code class="docutils literal"><span class="pre">env.P4_PATH</span></code> (but not both at a time)</td>
</tr>
</tbody>
</table>
</div></blockquote>
</li>
</ol>
</div>
<div class="section" id="create-basic-postcommit-configuration">
<h2>Create basic postcommit configuration<a class="headerlink" href="#create-basic-postcommit-configuration" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple" start="0">
<li>After creating new build configuration, go to <cite>Build Configuration Settings</cite></li>
<li>To get artifacts from default artifact directory, go to <cite>General Settings</cite>,
find <cite>Artifact paths</cite> field and add <code class="docutils literal"><span class="pre">artifacts/*</span></code> line there</li>
<li>To trigger builds via TeamCity but download via Universum, go to <cite>Version Control Settings</cite>,
attach required
<a class="reference external" href="https://confluence.jetbrains.com/display/TCD9/VCS+root">VCS Root</a>
and set <cite>VCS checkout mode</cite> to <code class="docutils literal"><span class="pre">Do</span> <span class="pre">not</span> <span class="pre">checkout</span> <span class="pre">files</span> <span class="pre">automatically</span></code></li>
<li>Go to <cite>Triggers</cite> and add <cite>VCS Trigger</cite> with required settings</li>
<li>Go to <cite>Build steps</cite>, press <code class="docutils literal"><span class="pre">Add</span> <span class="pre">build</span> <span class="pre">step</span></code>, in <cite>Runner type</cite> scroll down to
your project runners and select a meta-runner created earlier</li>
</ol>
<p>After setting up all the environment variables right, you must get the fully working configuration.</p>
</div>
<div class="section" id="create-configuration-for-custom-builds">
<h2>Create configuration for custom builds<a class="headerlink" href="#create-configuration-for-custom-builds" title="Permalink to this headline">¶</a></h2>
<ol class="arabic" start="0">
<li><p class="first">As in postcommit, specify <code class="docutils literal"><span class="pre">artifacts/*</span></code> in <cite>Artifact paths</cite>
and add your meta-runner as a <cite>Build step</cite></p>
</li>
<li><p class="first">Attaching <cite>VCS root</cite> is not necessary because custom build configurations
usually do not use <cite>VCS Trigger</cite>; instead of this, add the following parameters to configuration:</p>
<blockquote>
<div><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">env.SYNC_CHANGELIST:</th><td class="field-body">can be a CL number or a list of sync CLs for several different <cite>P4_MAPPINGS</cite>,
see <a class="reference internal" href="args.html"><span class="doc">'--p4-sync' option description</span></a></td>
</tr>
<tr class="field-even field"><th class="field-name">env.SHELVE_CHANGELIST:</th><td class="field-body">one or several coma-separated CLs to unshelve for the build</td>
</tr>
</tbody>
</table>
</div></blockquote>
</li>
</ol>
</div>
<div class="section" id="integrate-with-swarm">
<h2>Integrate with Swarm<a class="headerlink" href="#integrate-with-swarm" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple" start="0">
<li>Go to <cite>Build Configuration Settings</cite> (or to <cite>Project Settings</cite>, if you plan on having
more than one Swarm-related configuration)</li>
<li>Create <code class="docutils literal"><span class="pre">env.REVIEW</span></code>, <code class="docutils literal"><span class="pre">env.PASS</span></code> and <code class="docutils literal"><span class="pre">env.FAIL</span></code> parameters and leave them empty</li>
<li>In <cite>Build Configuration Settings</cite> --&gt; <cite>Parameters</cite> and add <code class="docutils literal"><span class="pre">--report-to-review</span></code> option in <code class="docutils literal"><span class="pre">env.CONFIGURATION_PARAMETERS</span></code></li>
<li>If needed, add other <a class="reference internal" href="args.html"><span class="doc">Swarm options</span></a>, such as <code class="docutils literal"><span class="pre">--report-build-start</span></code>
and <code class="docutils literal"><span class="pre">--report-build-success</span></code></li>
<li>Go to Swarm project settings, check in <cite>Automated tests</cite> check-box and follow <a class="reference external" href="https://www.perforce.com/perforce/r16.2/manuals/swarm/quickstart.integrate_test_suite.html">this instruction</a></li>
</ol>
<p>The resulting URL you should insert in text field. The URL should look like:</p>
<blockquote>
<div>http://&lt;user&gt;:&lt;password&gt;&#64;&lt;TeamCity URL&gt;/httpAuth/action.html?add2Queue=&lt;configuration&gt;
&amp;name=env.SHELVE_CHANGELIST&amp;value={change}&amp;name=env.PASS&amp;value={pass}&amp;name=env.FAIL&amp;value={fail}
&amp;name=env.REVIEW&amp;value={review}</div></blockquote>
<p>where</p>
<blockquote>
<div><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">user:</th><td class="field-body">is a name of a TeamCity user triggering Swarm builds (preferably some bot)</td>
</tr>
<tr class="field-even field"><th class="field-name">password:</th><td class="field-body">is that user's password</td>
</tr>
<tr class="field-odd field"><th class="field-name">TeamCity URL:</th><td class="field-body">is actual server URL, including port if needed</td>
</tr>
<tr class="field-even field"><th class="field-name">configuration:</th><td class="field-body">is an ID of your Swarm configuration (see <code class="docutils literal"><span class="pre">Build</span> <span class="pre">configuration</span> <span class="pre">ID</span></code> in settings)</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>or, if your TeamCity supports anonymous build triggering, <cite>user &amp; password</cite> can be omitted along with
<code class="docutils literal"><span class="pre">httpAuth/</span></code> parameter.</p>
<ol class="arabic">
<li><p class="first">Probably, in the <cite>POST Body</cite> field you should additionally insert below line:</p>
<blockquote>
<div><p>name=STATUS&amp;value={status}</p>
</div></blockquote>
</li>
</ol>
<p>or, any other parameter. This is a workaround for TeamCity requirement for using POST method to trigger builds.</p>
</div>
<div class="section" id="configure-project-and-configurations-using-git">
<h2>Configure project and configurations using Git<a class="headerlink" href="#configure-project-and-configurations-using-git" title="Permalink to this headline">¶</a></h2>
<ol class="arabic" start="0">
<li><p class="first">Create a sub-project to a top-level project for Universum configurations</p>
</li>
<li><p class="first">In <cite>Parameters</cite> set <code class="docutils literal"><span class="pre">env.CONFIG_PATH</span></code> relative to project root</p>
</li>
<li><p class="first">Add oject-wide Git parameters:</p>
<blockquote>
<div><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">env.GIT_REPO:</th><td class="field-body">a parameter to pass to <code class="docutils literal"><span class="pre">git</span> <span class="pre">clone</span></code>, e.g. <code class="docutils literal"><span class="pre">ssh://user&#64;server/project-name/</span></code></td>
</tr>
<tr class="field-even field"><th class="field-name">env.GIT_REFSPEC:</th><td class="field-body">if some non-default
<a class="reference external" href="https://git-scm.com/book/en/v2/Git-Internals-The-Refspec">git refspec</a>
is needed for project, specify it here</td>
</tr>
</tbody>
</table>
</div></blockquote>
</li>
<li><p class="first">Create post-commit configurations <a class="reference internal" href="#create-basic-postcommit-configuration">as described above</a></p>
</li>
<li><p class="first">When creating custom build configurations, use the following parameters instead of P4-specific:</p>
<blockquote>
<div><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">env.GIT_CHECKOUT_ID:</th><td class="field-body">parameter to be passed to <code class="docutils literal"><span class="pre">git</span> <span class="pre">checkout</span></code>; can be commit hash, branch name,
tag, etc. (see <a class="reference external" href="https://git-scm.com/docs/git-checkout">official manual</a> for details)</td>
</tr>
<tr class="field-even field"><th class="field-name">env.GIT_CHERRYPICK_ID:</th><td class="field-body">one or several coma-separated commit IDs to cherry-pick
(see <a class="reference external" href="https://git-scm.com/docs/git-cherry-pick">official manual</a> for details)</td>
</tr>
</tbody>
</table>
</div></blockquote>
</li>
</ol>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="changelog_ref.html" class="btn btn-neutral float-right" title="Change log" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="configuration_support.html" class="btn btn-neutral" title="&#39;configuration_support&#39; module" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright Samsung Electornics Co., Ltd..

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.12.4',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>